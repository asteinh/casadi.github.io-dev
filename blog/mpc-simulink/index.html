

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
      <title>CasADi - Blog</title>
    

    
    <link href="https://asteinh.github.io/casadi.github.io-dev/_css/font-awesome.min.css" rel="stylesheet">

    
    <link href="https://asteinh.github.io/casadi.github.io-dev/_css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://asteinh.github.io/casadi.github.io-dev/_css/pygments-default.css" rel="stylesheet">

    
    <link href="https://asteinh.github.io/casadi.github.io-dev/_css/casadi-theme.min.css" rel="stylesheet">

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ['\\(','\\)'] ],
          displayMath: [ ['$$','$$'], ['\\[','\\]'] ],
          processEnvironments: false
        }
      });
    </script>

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  </head>

  <body>



<nav class="navbar fixed-top navbar-expand-lg nav-top">
  <div class="container">
    <a class="navbar-brand" href="https://asteinh.github.io/casadi.github.io-dev/"></a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars" aria-hidden="true"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/casadi.github.io-dev/">Home</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/casadi.github.io-dev/get/">Try/Install</a>
          </li>
        
          
          <li class="nav-item active">
          
            <a class="nav-link" href="/casadi.github.io-dev/blog/">Blog</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/casadi.github.io-dev/docs/">Docs</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/casadi.github.io-dev/events/">Workshops</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/casadi.github.io-dev/support/">Support</a>
          </li>
        
          
          <li class="nav-item">
          
            <a class="nav-link" href="/casadi.github.io-dev/about/">About</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>


<div id="main" class="container">
  <div class="row">
    <div class="col">

      <p>CasADi is not a monolithic tool. We can easily couple it to other software to have more fun.
Today we'll be exploring a <em>simple</em> coupling with Simulink. We'll be showing off nonlinear MPC (NMPC).</p>
<figure class=" default">
  <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_block.png" target="_blank">
<pre><code>&lt;img src=&quot;https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_block.png&quot;  /&gt;
</code></pre>
  </a>
  <figcaption>
    <h1>Simulink block diagram</h1>
  </figcaption>
</figure>
<h1 id="the-details">The details</h1>
<p>For plant model, we'll be using the familiar <a href="https://en.wikipedia.org/wiki/Van_der_Pol_oscillator">Van der Pol oscillator</a> ode:</p>
<p>$$
\frac{d\begin{bmatrix}x_1\ x_2\end{bmatrix}}{dt} = \begin{bmatrix}(1-x_2^2), x_1-x_2+u\ x_1\end{bmatrix}.
$$</p>
<p>In the above Simulink block diagram, the <code>rhs</code> MATLAB function block encodes this ode:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab" data-lang="matlab"><span style="color:#66d9ef">function</span> y = <span style="color:#a6e22e">rhs</span>(x,u)
  y = [(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>x(<span style="color:#ae81ff">2</span>)^<span style="color:#ae81ff">2</span>)<span style="color:#f92672">*</span>x(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> x(<span style="color:#ae81ff">2</span>) <span style="color:#f92672">+</span> u; x(<span style="color:#ae81ff">1</span>)];
<span style="color:#66d9ef">end</span>
</code></pre></div><p>The <code>casadi_block</code> computes the discrete control signal by solving an Optimal Control Problem (OCP).
The act of closing the loop with the continuous plant makes our setup effectively an MPC controller.</p>
<p>The OCP problem here simply drives the states to zero:</p>
<p>$$
\begin{align}
\underset{\begin{array}{c}x(\cdot), u(\cdot)\end{array}}
{\text{minimize}}\quad &amp; \int_{0}^{T}{ \left( x_1(t)^2 + x_2(t)^2 + u(t)^2 \right) , dt} \newline
\text{subject to} , \quad
&amp; \left\{\begin{array}{l}
\dot{x}_1(t) = (1-x_2(t)^2) , x_1(t) - x_2(t) + u(t) \newline
\dot{x}_2(t) = x_1(t) \newline
-1.0 \le u(t) \le 1.0, \quad x_1(t) \ge -0.25
\end{array}\right.
\quad  t \in [0,T] \newline
&amp; x_1(0)=\bar{x}_1, \quad x_2(0)=\bar{x}_2
\end{align}
$$</p>
<p>We will use the <a href="https://github.com/casadi/casadi/blob/3.1.0/docs/examples/matlab/direct_multiple_shooting.m">multiple shooting transcription from the CasADi examples</a> to cast the OCP to an NLP problem. In short, the multiple shooting code reads like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab" data-lang="matlab">w = {}; <span style="color:#75715e">% decision variables</span>
g = {}; <span style="color:#75715e">% cosntraints</span>
J = <span style="color:#ae81ff">0</span>; <span style="color:#75715e">% objective</span>

<span style="color:#75715e">% Initial conditions</span>
X0 = MX.sym(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">X0&#39;</span>, <span style="color:#ae81ff">2</span>);

<span style="color:#75715e">% Formulate the NLP</span>
Xk = X0;
<span style="color:#66d9ef">for</span> k=<span style="color:#ae81ff">0</span>:N<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#75715e">% New NLP variable for the control</span>
    Uk = MX.sym(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">U&#39;</span>);
    w = {w{:}, Uk};

    <span style="color:#75715e">% Integrate till the end of the interval</span>
    Fk = F(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x0&#39;</span>, Xk, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">p&#39;</span>, Uk);
    Xk_end = Fk.xf;
    J=J<span style="color:#f92672">+</span>Fk.qf;

    <span style="color:#75715e">% New NLP variable for state at end of interval</span>
    Xk = MX.sym(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">X&#39;</span>, <span style="color:#ae81ff">2</span>);
    w = {w{:}, Xk};

    <span style="color:#75715e">% Add equality constraint</span>
    g = {g{:}, Xk_end<span style="color:#f92672">-</span>Xk};
<span style="color:#66d9ef">end</span>

<span style="color:#75715e">% Create an NLP solver</span>
prob = struct(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">f&#39;</span>, J, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x&#39;</span>, vertcat(w{:}), <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">g&#39;</span>, vertcat(g{:}));
solver = nlpsol(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">solver&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ipopt&#39;</span>, prob);
</code></pre></div><p>Recall from that example the solution plot:</p>
<figure class=" default">
  <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/reference.png" target="_blank">
<pre><code>&lt;img src=&quot;https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/reference.png&quot;  /&gt;
</code></pre>
  </a>
  <figcaption>
    <h1>Reference solution from multiple shooting example</h1>
  </figcaption>
</figure>
<p>As we all know, CasADi makes an important distinction between <em>initialisation</em> and <em>evaluation</em> steps.
We would not want to construct an NLP afresh at every sampling time!
Rather, we'd like to construct the NLP once, and simply evaluate it repeatedly using slightly different numerical inputs.
For this purpose, we chose a <code>MATLAB System</code> block in Simulink.</p>
<p>In abbreviated form, the code in that block reads:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-matlab" data-lang="matlab"><span style="color:#66d9ef">classdef</span> casadi_block <span style="color:#f92672">&lt;</span> matlab.System
    <span style="color:#66d9ef">properties</span> (Access = private)
        casadi_solver
        lbx
        ubx
    <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">methods</span> (Access = protected)
<span style="color:#66d9ef">        function</span> <span style="color:#a6e22e">setupImpl</span>(obj,~,~)
            obj.casadi_solver = nlpsol(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">solver&#39;</span>, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ipopt&#39;</span>, prob, options);
            obj.lbx = lbw;
            obj.ubx = ubw;
        <span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">        function</span> u = <span style="color:#a6e22e">stepImpl</span>(obj,x,t)
            lbw = obj.lbx;
            ubw = obj.ubx;
            solver = obj.casadi_solver;
            lbw(<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">2</span>) = x;
            ubw(<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">2</span>) = x;
            sol = solver(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x0&#39;</span>, w0, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lbx&#39;</span>, lbw, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ubx&#39;</span>, ubw,<span style="color:#75715e">...</span>
                        <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">lbg&#39;</span>, obj.lbg, <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">ubg&#39;</span>, obj.ubg);

            u = full(sol.x(<span style="color:#ae81ff">3</span>));
        <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>As you can see, <code>setupImpl</code> takes care of constructing the NLP, and <code>stepImpl</code> solves the actual NLP while constraining $x_1(0)$ and $x_2(0)$ to the state <em>measurement</em> coming in from Simulink.</p>
<p>In general, you may distinguish several approaches to bring CasADi computations into simulink:</p>
<ol>
<li>write CasADi-Matlab code, and use an <code>interpreted Matlab code</code> in Simulink</li>
<li>write CasADi-Matlab code, and use CasADi's codegenerator to spit out a pure c function (or mex file). Then, interface that pure c function in simulink</li>
<li>write a mex file from scratch using CasADi-C++ code</li>
</ol>
<p>We used option 1 here. It's the most simple way. Obviously this is not the most efficient way,
but since all of CasADi's number-crunching happens in compiled libraries, <code>interpreted Matlab code</code> is not as bad as it sounds perhaps.
Anyway, make sure that you indicate to Simulink that the code is <code>interpreted</code>:</p>
<figure class=" default">
  <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/interpreted.png" target="_blank">
<pre><code>&lt;img src=&quot;https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/interpreted.png&quot;  /&gt;
</code></pre>
  </a>
  <figcaption>
    <h1>Simulink block diagram</h1>
  </figcaption>
</figure>
<p>Let's jump to results.</p>
<h1 id="the-results">The results</h1>
<p>MPC control signal:</p>
<figure class=" default">
  <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_control.png" target="_blank">
<pre><code>&lt;img src=&quot;https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_control.png&quot;  /&gt;
</code></pre>
  </a>
  <figcaption>
    <h1>MPC control signal</h1>
  </figcaption>
</figure>
<p>State evolution:</p>
<figure class=" default">
  <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_state.png" target="_blank">
<pre><code>&lt;img src=&quot;https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_state.png&quot;  /&gt;
</code></pre>
  </a>
  <figcaption>
    <h1>State evolution</h1>
  </figcaption>
</figure>
<p>Note how the control trajectory (up to t=10s) matches the reference solution further up in this post.
The state trajectory matches too, but Simulink shows you more detail: you see the smooth time-evolution of the system in-between the sampling times.
Pretty neat, huh?
Just for fun, I dropped in some noised at around t=10s. The MPC controller manages to recover from this.</p>
<p>This post showed a quick way to drop your CasADi code into Simulink.
We're curious what you'll cook up based on this example. Enjoy!</p>
<p>Downloads: <a href="casadi_block.m">casadi_block.m</a>, <a href="mpc_demo.slx">mpc_demo.slx</a></p>

      <div class="card-columns">
        
          
            
            <div class="card border-success">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink2/mpc_diagram.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">CasADi-driven MPC in Simulink (part 2)</h5>
                <p>In this post, we have a new take on nonlinear MPC in Simulink using CasADi.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink2/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>3 mins</span>

                posted December 19, 2019
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/nlp_sens/nlp_1d.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">Sensitivities of parametric NLP</h5>
                <p>In this post, we explore the parametric sensitivities of a nonlinear program (NLP).
While we use &lsquo;Opti stack&rsquo; syntax for modeling, differentiability of NLP solvers works all the same without Opti.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/nlp_sens/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>3 mins</span>

                posted October 28, 2019
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/parfor/parfor1.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">Parfor</h5>
                <p>In this post we'll explore how to use Matlab's parfor with a CasADi nonlinear program.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/parfor/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>3 mins</span>

                posted August 23, 2018
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/tensorflow/gpflow1d_min.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">Tensorflow and CasADi</h5>
                <p>In this post we'll explore how to couple <a href="https://www.tensorflow.org">Tensorflow</a> and CasADi.
Thanks to Jonas Koch (student @ Applied Mathematics WWU Muenster) for delivering inspiration and example code.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/tensorflow/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>5 mins</span>

                posted July 30, 2018
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
              <div class="card-body">
                <h5 class="card-title">Breaking free of CasADi&#39;s solvers</h5>
                <p>Once you've modeled your optimization problem in CasADi,
you don't have to stick to the solvers we interface.</p>
<p>In this post, we briefly demonstrate how we can make CasADi and Matlab's <code>fmincon</code> cooperate.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/fmincon/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>3 mins</span>

                posted July 13, 2018
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/s-function/simulink.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">CasADi codegen and S-Functions</h5>
                <p>While the <a href="http://docs.casadi.org">user guide</a> does explain code-generation in full detail,
it is handy to have a demonstration in a real environment like Matlab's S-functions.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/s-function/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>3 mins</span>

                posted July 13, 2018
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/nlp-scaling/conv.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">On the importance of NLP scaling</h5>
                <p>During my master's thesis at KULeuven on optimal control, one of the take-aways were that it's important to scale your variables. It helps convergence if the variables are in the order of 0.01 to 100.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/nlp-scaling/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>2 mins</span>

                posted September 15, 2017
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/ocp/hyperworks-industries-architecture-screen-capture-6-726x383.jpg" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">Optimal control problems in a nutshell</h5>
                <p>Optimization.
There's a mathematical term that sounds familiar to the general public.
Everyone can imagine engineers working hard to make your car run 1% more fuel-efficient,
or to slightly increase profit margins for a chemical company.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/ocp/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>5 mins</span>

                posted September 15, 2017
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/opti/rosenbrock1.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">Easy NLP modeling in CasADi with Opti</h5>
                <p><a href="http://install33.casadi.org">Release 3.3.0</a> of CasADi introduced a compact syntax for NLP modeling, using a set of helper classes, collectively known as &lsquo;Opti stack&rsquo;.</p>
<p>In this post, we briefly demonstrates this functionality.</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/opti/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>3 mins</span>

                posted September 14, 2017
              </div>
            </div>
          
        
          
            
            <div class="card">
            
              
                <img class="card-img-top" src="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/simulink_block.png" alt="Card image cap" />
              
              <div class="card-body">
                <h5 class="card-title">CasADi-driven MPC in Simulink (part 1)</h5>
                <p>CasADi is not a monolithic tool. We can easily couple it to other software to have more fun.
Today we'll be exploring a <em>simple</em> coupling with Simulink. We'll be showing off nonlinear MPC (NMPC).</p>
                <a href="https://asteinh.github.io/casadi.github.io-dev/blog/mpc-simulink/" class="btn btn-primary">Read more</a>
              </div>
              <div class="card-footer text-muted text-right">
                <span class="reading-time-short text-muted"><i class="fa fa-clock-o"></i>4 mins</span>

                posted March 8, 2017
              </div>
            </div>
          
        
          
        
      </div>
    </div>
  </div>
</div>

    <footer>
      <div class="container">
        <div class="row justify-content-md-center">
          <div class="col-md-auto text-center">
            <ul id="social" class="list-inline">
              
                <li class="list-inline-item">
                  <a href="https://github.com/casadi/casadi" title="github">
                    <i class="fa fa-github"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://twitter.com/casadi_software" title="twitter">
                    <i class="fa fa-twitter"></i>
                  </a>
                </li>
              
                <li class="list-inline-item">
                  <a href="https://www.youtube.com/channel/UC3VDpv5Pi3R-a2VkcJN1RLw" title="youtube">
                    <i class="fa fa-youtube"></i>
                  </a>
                </li>
              
            </ul>
            <p class="copyright">Copyright 2020.</p>
          </div>
        </div>
      </div>
    </footer>

    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>

    
    <script src="https://asteinh.github.io/casadi.github.io-dev/_js/bootstrap.min.js"></script>

    
    <script src="https://asteinh.github.io/casadi.github.io-dev/_js/scripts.js"></script>

    
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS_CHTML">
</script>

    
  </body>

</html>

